name: Build PAK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: MyRomanceGuessWho

      - name: Download LSLib
        run: |
          $releases = Invoke-RestMethod -Uri "https://api.github.com/repos/Norbyte/lslib/releases/latest"
          $asset = $releases.assets | Where-Object { $_.name -like "ExportTool-*.zip" } | Select-Object -First 1
          Invoke-WebRequest -Uri $asset.browser_download_url -OutFile lslib.zip
          Expand-Archive -Path lslib.zip -DestinationPath lslib

      - name: Build PAK
        shell: bash
        run: |
          set -e
          
          MODDIR="MyRomanceGuessWho"
          PAKNAME="MyRomanceGuessWho"
          META="$MODDIR/Mods/$PAKNAME/meta.lsx"
          
          echo "Reading metadata from: $META"
          
          # Extract values from meta.lsx
          extract_attribute() {
              local attr_id="$1"
              grep -o "<attribute id=\"$attr_id\"[^>]*value=\"[^\"]*\"" "$META" | head -1 | sed 's/.*value="\([^"]*\)".*/\1/'
          }
          
          FOLDERVALUE=$(extract_attribute "Folder")
          UUIDVALUE=$(extract_attribute "UUID")
          NAMEVALUE=$(extract_attribute "Name")
          VERSION=$(extract_attribute "Version64")
          
          echo "Folder: $FOLDERVALUE"
          echo "UUID: $UUIDVALUE"
          echo "Name: $NAMEVALUE"
          echo "Version: $VERSION"
          
          # Validate folder matches pak name
          if [ "$FOLDERVALUE" != "$PAKNAME" ]; then
              echo "Error: Folder mismatch - $PAKNAME vs $FOLDERVALUE"
              exit 1
          fi
          
          # Create temp directory
          mkdir -p temp
          PAKPATH="temp/$PAKNAME.pak"
          
          # Create mod pack
          echo "Creating PAK file..."
          ./lslib/divine.exe -g "bg3" --action "create-package" --source "$MODDIR" --destination "$PAKPATH" -l "all"
          
          if [ ! -f "$PAKPATH" ]; then
              echo "Error: Failed to create PAK file"
              exit 1
          fi
          
          echo "PAK created successfully"
          ls -la "$PAKPATH"
          
          # Calculate MD5
          MD5=$(md5sum "$PAKPATH" | awk '{print $1}')
          echo "MD5: $MD5"
          
          # Create info.json
          cat > "temp/info.json" << EOF
          {
              "mods": [
                  {
                      "modName": "$NAMEVALUE",
                      "UUID": "$UUIDVALUE",
                      "folderName": "$PAKNAME",
                      "version": "$VERSION",
                      "MD5": "$MD5"
                  }
              ]
          }
          EOF
          
          echo "Created info.json"
          cat temp/info.json
          
          # Create zip
          echo "Creating zip archive..."
          cd temp
          7z a "../$PAKNAME.zip" ./*
          cd ..
          
          echo ""
          echo "All done!"
          ls -la "$PAKNAME.zip"

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyRomanceGuessWho
          path: MyRomanceGuessWho.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: MyRomanceGuessWho.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
